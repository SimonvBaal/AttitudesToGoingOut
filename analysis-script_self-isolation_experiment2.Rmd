---
title: "Self-Isolation Experiments 2 & 3"
author: "Simon van Baal"
date: "09/08/2020"
output: html_document
---

```{r setup, include=FALSE}

library(afex)
library(ggsignif)
library(stats4)
library(emmeans)
library(lawstat)
library(cowplot)
#library(ggpubr)
library(grid)
library(kableExtra)
library(bayestestR)
library(tidyverse)
library(ordinalCont)

```


```{r Ordinal analysis}
ordinalDataExp2 <-
  dataExp2 %>%
  mutate(VAScat =
           factor(
             ifelse(
               VAS <= 10, 1,
               ifelse(
                 VAS <= 20, 2,
                 ifelse(
                   VAS <= 30, 3,
                   ifelse(
                     VAS <= 40, 4,
                     ifelse(
                       VAS <= 50, 5,
                       ifelse(
                         VAS <= 60, 6,
                         ifelse(
                           VAS <= 70, 7,
                           ifelse(
                             VAS <= 80, 8,
                             ifelse(
                              VAS <= 90, 9,
                               ifelse(
                                 VAS <= 100, 10, NA
                               ))))))))))))

ordinalExp2 <- 
  ordinal::clmm(
  VAScat ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = ordinalDataExp2,
    link = "logit"
)


pairs(emmeans(ordinalExp2, ~Treatment|Risk))


```

```{r Analysis ocm}

contrasts(dataExp2$Perspective) <- contr.sum(2)
contrasts(dataExp2$Sex) <- contr.sum(2)

ocmAllTreatmentExp2 <-
  ocm(
    VAS ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = dataExp2,
    link = "logit"
  )

dataExp2 <-
  dataExp2 %>%
  mutate(Risk = relevel(Risk, ref = "Minimal Risk"))

ocmTreatmentRelevelExp2 <-
  ocm(
    VAS ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = dataExp2,
    link = "logit"
  )

dataExp2 <-
  dataExp2 %>%
  mutate(Risk = relevel(Risk, ref = "Low Risk"))

ocmTreatmentRelevel2Exp2 <-
  ocm(
    VAS ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = dataExp2,
    link = "logit"
  )

# For the main effect of treatment:

contrasts(dataExp2$Risk) <- contr.sum(3)

ocmTreatmentTreatmentExp2 <-
  ocm(
    VAS ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = dataExp2,
    link = "logit"
  )

contrasts(dataExp2$Treatment) <- contr.sum(2)
contrasts(dataExp2$Perspective) <- contr.treatment(2)

ocmPerspectiveTreatmentExp2 <-
  ocm(
    VAS ~
      Treatment * Risk +
      Perspective +
      (1 | ResponseId),
    data = dataExp2,
    link = "logit"
  )

# For comparisons of risk levels

contrasts(dataExp2$Perspective) <- contr.sum(2)
contrasts(dataExp2$Risk) <- contr.treatment(3)

ocmTreatmentRiskExp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective + 
        (1|ResponseId),
      data = dataExp2,
      link = "logit")


dataExp2 <-
  dataExp2 %>%
  mutate(Risk = relevel(Risk, ref = "Minimal Risk"))

ocmTreatmentRisk2Exp2 <-
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective + 
        (1|ResponseId),
      data = dataExp2,
      link = "logit")

contrasts(dataExp2$Risk) <- contr.sum(3)

# Now analysing the effects of age and sex

ocmAgeSexExp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective + 
        AgeZeroCenter +
        Sex +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")

contrasts(dataExp2$Risk) <- contr.treatment(3)
# Minimal risk is the reference level.
ocmAgeRiskInteractionExp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective + 
        AgeZeroCenter*Risk +
        Sex +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")


```


```{r Likelihood ratio tests}



ocm1Exp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")
beepr::beep()
ocm2Exp2 <- 
  ocm(VAS ~ 
        Treatment + Risk +
        Perspective +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")

ocm3Exp2 <- 
  ocm(VAS ~ 
        Treatment + 
        Perspective +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")


ocm4Exp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective +
        Age * Risk +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")

ocm5Exp2 <- 
  ocm(VAS ~ 
        Treatment*Risk +
        Perspective +
        Age +
        (1|ResponseId),
      data = dataExp2,
      link = "logit")

LRTExp2 <-
  anova(ocm1Exp2, ocm2Exp2, ocm3Exp2)
LRTExp2

# Main effect of sex
# lrSexExp2 <- 
#   2 * (ocm1Exp2$penlogLik - ocm2Exp2$penlogLik)
# edfSexExp2 <-
#   abs(ocm1Exp2$edf - ocm2Exp2$edf)
# dchisq(lrSexExp2, df = edfSexExp2)

```


## Reporting model coefficients 
```{r VAS marker effect}
estimateMarker <- exp(ocmTreatmentTreatmentExp2$coefficients[2])
ciLowerMarker <- exp(ocmTreatmentTreatmentExp2$coefficients[2] - 1.96 * .1427)
ciUpperMarker <- exp(ocmTreatmentTreatmentExp2$coefficients[2] + 1.96 * .1427)

estimateMarkerHigh <- exp(ocmAllTreatmentExp2$coefficients[2])
ciLowerMarkerHigh <- exp(ocmAllTreatmentExp2$coefficients[2] - 1.96 * .1450)
ciupperMarkerHigh <- exp(ocmAllTreatmentExp2$coefficients[2] + 1.96 * .1450)

estimateMarkerLow <- exp(ocmAllTreatmentRelevelExp2$coefficients[2])
ciLowerMarkerLow <- exp(ocmAllTreatmentRelevelExp2$coefficients[2] - 1.96 * x)
ciupperMarkerLow <- exp(ocmAllTreatmentRelevelExp2$coefficients[2] + 1.96 * x)

estimateMarkerMinimal <- exp(ocmAllTreatmentRelevel2Exp2$coefficients[2])
ciLowerMarkerMinimal <- exp(ocmAllTreatmentRelevel2Exp2$coefficients[2] - 1.96 * x)
ciupperMarkerMinimal <- exp(ocmAllTreatmentRelevel2Exp2$coefficients[2] + 1.96 * x)


p.adjust(c(.01, .021, .03), method = 'fdr')

```

```{r Risk effects}
estimateHighLowExp2 <- exp(ocmTreatmentRiskExp2$coefficients[4])
ciLowerHighLowExp2 <- exp(ocmTreatmentRiskExp2$coefficients[4] - 1.96 * .0388)
ciUpperHighLowExp2 <- exp(ocmTreatmentRiskExp2$coefficients[4] + 1.96 * .0388)

estimateMinimalLowExp2 <- 1/exp(ocmTreatmentRiskExp2$coefficients[3])
ciLowerMinimalLowExp2 <- 1/exp(ocmTreatmentRiskExp2$coefficients[3] + 1.96 * .0467)
ciUpperMinimalLowExp2 <- 1/exp(ocmTreatmentRiskExp2$coefficients[3] - 1.96 * .0467)


estimateMinimalHighExp2 <- exp(ocmTreatmentRisk2Exp2$coefficients[4])
ciLowerMinimalHighExp2 <- exp(ocmTreatmentRisk2Exp2$coefficients[4] - 1.96 * .0424)
ciUpperMinimalHighExp2 <- exp(ocmTreatmentRisk2Exp2$coefficients[4] + 1.96 * .0424)


```

```{r Perspective effect}

estimatePerspectiveExp2 <- exp(ocmPerspectiveTreatmentExp2$coefficients[5])
ciLowerPerspectiveExp2 <- exp(ocmPerspectiveTreatmentExp2$coefficients[5] - 1.96 * .1421)
ciUpperPerspectiveExp2 <- exp(ocmPerspectiveTreatmentExp2$coefficients[5] + 1.96 * .1421)

```



```{r Analysis cont'd}
Aggregates %>% group_by(Treatment) %>% summarise(mean = mean(Self_Rank),
                                                   sd = sd(Self_Rank))

MWtest <- wilcox.test(Aggregates$Self_Rank, mu = 50, alternative = 'greater')
wilcox.test(Aggregates$Self_Rank, mu = 50, conf.int = T, conf.level = .95)

Z = qnorm(MWtest$p.value)
Z

bf.test(VAS ~ Treatment, data = Aggregates)

dataExp2 %>% 
  mutate(extremeObs = ifelse(VAS <= .1 | VAS >= .9 ))

AggregatesExp1 <- 
  Data %>% group_by(ResponseId) %>% summarise(Mean = mean(VAS), SD = sd(VAS))
experimentComparison <- 
  BayesFactor::ttestBF(Aggregates$VAS, AggregatesExp1$Mean)
summary(experimentComparison)
plot(AggregatesExp1$Mean, Aggregates$VAS)



```


```{r Assessing support for null findings}
# Perspective factor

bayesModels <- bayesfactor_models(model0, model1, model2, model3, denominator = 4)
bayesfactor_inclusion(bayesModels)


```

